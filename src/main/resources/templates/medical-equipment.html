<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Equipo</title>
    <link rel="stylesheet" th:href="@{/bootstrap/css/bootstrap.css}">
    <link rel="stylesheet" th:href="@{/boxicons/css/boxicons.css}">
    <!--Website boxicons -> https://boxicons.com/-->
    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/css/tables.css}">
    <script th:src="@{/jquery/jquery.js}" type="text/javascript"></script>
</head>
<body>

<!-- navbar -->
<nav th:replace="~{layout/navbar :: navbar}"></nav>

<!-- sidebar -->
<nav th:replace="~{layout/sidebar :: sidebar}"></nav>

<!-- Content Wrapper -->
<main class="main-content">
    <div class="breadcrumb">HOME / GESTIÓN DE EQUIPOS / EQUIPO</div>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2>Equipo</h2>
    </div>

    <form th:object="${equip}" th:action="@{/medical-equipment/save}" method="post">
        <div class="row">
            <h3 class="text-start mb-3">Detalles</h3>
            <div class="col-md-6">
                <div class="mb-3 row">
                    <label for="codcla" class="col-sm-3 form-label">Clase: </label>
                    <div class="col-sm-9">
                        <div class="input-group">
                            <input type="text" class="form-control" id="codcla" name="codcla"
                                   placeholder="01 Riesgo Bajo" th:field="*{codcla}" readonly>
                            <span class="input-group-text" data-bs-toggle="modal" data-bs-target="#classesModal">
                        <i class='bx bx-search bx-sm'></i>
                    </span>
                        </div>
                    </div>
                </div>

                <div class="mb-3 row">
                    <label for="codtcl" class="col-sm-3 form-label">Tipo: </label>
                    <div class="col-sm-9">
                        <div class="input-group">
                            <input type="text" class="form-control" id="codtcl" name="codtcl" placeholder="01 Tipo X"
                                   th:field="*{codtcl}" readonly>
                            <span class="input-group-text" data-bs-toggle="modal" data-bs-target="#typesModal">
                        <i class='bx bx-search bx-sm'></i>
                    </span>
                        </div>
                    </div>
                </div>

                <div class="mb-3 row">
                    <label for="codeqp" class="col-sm-3 form-label">Código: </label>
                    <div class="col-sm-9">
                        <div class="input-group">
                            <input type="text" class="form-control" id="codeqp" name="codeqp" placeholder="01-01-0001"
                                   th:field="*{codeqp}" readonly>
                        </div>
                    </div>
                </div>

                <div class="mb-3 row">
                    <label for="nomeqp" class="col-sm-3 form-label">Nombre: </label>
                    <div class="col-sm-9">
                        <div class="input-group">
                            <input type="text" class="form-control" id="nomeqp" name="nomeqp" placeholder="Nombre"
                                   th:field="*{nomeqp}">
                        </div>
                    </div>
                </div>

                <div class="mb-3 row">
                    <label for="codmar" class="col-sm-3 form-label">Marca: </label>
                    <div class="col-sm-9">
                        <div class="input-group">
                            <input type="text" class="form-control" id="codmar" name="codmar" placeholder="Marca"
                                   th:field="*{codmar}" readonly>
                            <span class="input-group-text" data-bs-toggle="modal" data-bs-target="#brandsModal">
                        <i class='bx bx-search bx-sm'></i>
                    </span>
                        </div>
                    </div>
                </div>

                <div class="mb-3 row">
                    <label for="anofab" class="col-sm-3 form-label">Año Fabricación: </label>
                    <div class="col-sm-9">
                        <input type="number" class="form-control" id="anofab" name="anofab"
                               placeholder="Año Fabricación"
                               min="1900"
                               max="2100" th:field="*{anofab}">
                    </div>
                </div>
            </div>

            <div class="col-md-6">

                <div class="mb-3 row">
                    <label for="modeqp" class="col-sm-3 form-label">Modelo: </label>
                    <div class="col-sm-9">
                        <div class="input-group">
                            <input type="text" class="form-control" id="modeqp" name="modeqp" placeholder="Modelo"
                                   th:field="*{modeqp}">
                        </div>
                    </div>
                </div>

                <div class="mb-3 row">
                    <label for="nsreqp" class="col-sm-3 form-label">Nro. Serie: </label>
                    <div class="col-sm-9">
                        <div class="input-group">
                            <input type="text" class="form-control" id="nsreqp" name="nsreqp" placeholder="Nro. Serie"
                                   th:field="*{nsreqp}">
                        </div>
                    </div>
                </div>

                <div class="mb-3 row">
                    <label for="nameOwner" class="col-sm-3 form-label">Propietario: </label>
                    <div class="col-sm-9">
                        <div class="input-group" data-bs-toggle="modal" data-bs-target="#ownersModal">
                            <input type="hidden" id="idPro" name="idPro">
                            <input type="text" class="form-control" id="nameOwner" name="nameOwner"
                                   placeholder="Propietario" readonly>
                            <span class="input-group-text">
                        <i class='bx bx-search bx-sm'></i>
                    </span>
                        </div>
                    </div>
                </div>

                <div class="mb-3 row">
                    <label for="nameArea" class="col-sm-3 form-label">Área: </label>
                    <div class="col-sm-9">
                        <div class="input-group" data-bs-toggle="modal" data-bs-target="#areasModal">
                            <input type="hidden" id="idArea" name="idArea">
                            <input type="text" class="form-control" id="nameArea" name="nameArea" placeholder="Área" readonly>
                            <span class="input-group-text">
                        <i class='bx bx-search bx-sm'></i>
                    </span>
                        </div>
                    </div>
                </div>

                <div class="mb-3 row">
                    <label for="esteqp" class="col-sm-3 form-label">Estado:</label>
                    <div class="col-sm-9">
                        <div class="input-group">
                            <select id="esteqp" name="esteqp" class="form-select" th:field="*{esteqp}">
                                <option value="">Seleccione</option>
                                <option value="activo">Activo</option>
                                <option value="inactivo">Inactivo</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="mb-3 row">
                    <label for="fchieq" class="col-sm-3 form-label">Fecha Ingreso: </label>
                    <div class="col-sm-9">
                        <input type="date" class="form-control" id="fchieq" name="fchieq" placeholder="fecha Ingreso"
                               th:field="*{fchieq}">
                    </div>
                </div>

            </div>
        </div>
        <div class="row">
            <div class="col-md-6">
                <h3 class="text-start">Descripción</h3>
                <div class="mb-3">
                    <label for="deseqp"></label>
                    <textarea class="form-control" placeholder="Descripción" id="deseqp" name="deseqp"
                              style="height: 100px" th:field="*{deseqp}"></textarea>
                </div>

            </div>
            <div class="col-md-6">
                <h3 class="text-start">Especificaciones</h3>
                <div class="mb-3">
                    <label for="espeqp"></label>
                    <textarea class="form-control" placeholder="Especificaciones" id="espeqp" name="espeqp"
                              style="height: 100px" th:field="*{espeqp}"></textarea>
                </div>
            </div>
        </div>

        <div class="col">
            <h3 class="text-center">Imágenes</h3>
            <div class="mb-3">
                <div class="d-flex justify-content-center align-items-center">
                    <input type="file" class="form-control mt-3 text-center" placeholder="Especificaciones" id="images"
                           style="width: 130px;">
                </div>
                <div class="d-flex justify-content-center align-items-center">
                    <div class="images-preview row">
                        <div class="col-6 col-md-3 mb-2">
                            <img class="img-fluid object-fit-cover" src="images/img.png" alt="Image"
                                 style="height: 150px; width: 100%;">
                        </div>
                        <div class="col-6 col-md-3 mb-2">
                            <img class="img-fluid object-fit-cover" src="images/img.png" alt="Image"
                                 style="height: 150px; width: 100%;">
                        </div>
                        <div class="col-6 col-md-3 mb-2">
                            <img class="img-fluid object-fit-cover" src="images/img.png" alt="Image"
                                 style="height: 150px; width: 100%;">
                        </div>
                        <div class="col-6 col-md-3 mb-2">
                            <img class="img-fluid object-fit-cover" src="images/img.png" alt="Image"
                                 style="height: 150px; width: 100%;">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-2 d-flex justify-content-end">
            <button class="btn btn-primary me-2 btn-save">Guardar</button>
            <button type="reset" class="btn btn-outline-secondary">Cancelar</button>
        </div>
    </form>
</main>

<!-- Modal Brands -->
<div th:replace="~{modal/brands-modal :: brandsModal}"></div>

<!-- Modal Owners -->
<div th:replace="~{modal/owners-modal :: ownersModal}"></div>

<!-- Modal Areas -->
<div th:replace="~{modal/areas-modal :: areasModal}"></div>

<!-- Modal Classes -->
<div th:replace="~{modal/classes-modal :: classesModal}"></div>

<script th:src="@{/bootstrap/js/bootstrap.js}" type="text/javascript"></script>
<script th:src="@{/jquery/jquery.js}" type="text/javascript"></script>
<script th:src="@{/js/script.js}" type="text/javascript"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const ownersModal = document.getElementById('ownersModal');
        ownersModal.addEventListener('show.bs.modal', fetchOwners);
    });

    // Obtener props
    const fetchOwners = async () => {
        try {
            const response = await fetch('/owner/all');
            const data = await response.json();
            populateTable(data);
        } catch (error) {
            console.error('Error al obtener propietarios:', error);
        }
    };

    // Rellenar tbody
    const populateTable = (owners) => {
        const tbody = document.querySelector('#ownersTBody');
        tbody.innerHTML = ''; // Limpiar tabla
        owners.forEach(owner => {
            const row = createOwnerRow(owner);
            tbody.appendChild(row);
        });
    };

    // Crear fila de tbody
    const createOwnerRow = (owner) => {
        const row = document.createElement('tr');
        row.innerHTML = `
        <td>${owner.nrodid}</td>
        <td>${owner.tdipro}</td>
        <td>${owner.sigpro}</td>
        <td>${owner.fchcre}</td>
        <td class="narrow-column">
            <i class="bx bx-edit-alt bx-md" onclick="openSecondModal('#ownerModal')"></i>
        </td>
        <td class="narrow-column">
            <i class="bx bx-check-circle bx-md" onclick="selectOwner('${encodeURIComponent(JSON.stringify(owner))}')"></i>
        </td>`;
        return row;
    };

    // Seleccionar un propietario
    function selectOwner(dataProp) {
        const prop = JSON.parse(decodeURIComponent(dataProp));
        document.getElementById('idPro').value = prop.idPro;
        document.getElementById('nameOwner').value = `${prop.sigpro} ${prop.nompro} ${prop.apppro} ${prop.apmpro}`;
        $('#ownersModal').modal('hide');
    }

    //***************************************/
    document.addEventListener('DOMContentLoaded', () => {
        const areasModal = document.getElementById('areasModal');
        areasModal.addEventListener('show.bs.modal', fetchAreas);
    });

    const fetchAreas = async () => {
        try {
            const response = await fetch('/area/all');
            const data = await response.json();
            populateArea(data);
        } catch (error) {
            console.error('Error:', error);
        }
    };

    const populateArea = (areas) => {
        const tbody = document.querySelector('#areasTBody');
        tbody.innerHTML = '';
        areas.forEach(area => {
            const row = createAreaRow(area);
            tbody.appendChild(row);
        });
    };

    // Crear fila de tbody
    const createAreaRow = (area) => {
        const row = document.createElement('tr');
        row.innerHTML = `
        <td>${area.codare}</td>
        <td>${area.desare}</td>
        <td class="narrow-column">
            <i class="bx bx-edit-alt bx-md" onclick="openSecondModal('#areaModal')"></i>
         </td>
         <td class="narrow-column">
            <i class="bx bx-check-circle bx-md" onclick="selectArea('${encodeURIComponent(JSON.stringify(area))}')"></i>
        </td>`;
        return row;
    };

    // Seleccionar area
    function selectArea(areaData) {
        const area = JSON.parse(decodeURIComponent(areaData));
        console.log("GMSSSS: ", area);

        document.getElementById('idArea').value = area.idAre;
        document.getElementById('nameArea').value = area.desare;

        // Modal data-range
        document.getElementById('areaCode2').value = area.codare;
        document.getElementById('areaName2').value = area.desare;
        openSecondModal('#dateRangeModal');
    }
</script>

</body>
</html>
